name: Unit Tests

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]

jobs:
  test:
    runs-on: ubuntu-latest

    env:
      TURNSTILE_ENABLED: 'False'
      DIRECTORY_USERNAME: ${{ secrets.DIRECTORY_USERNAME }}
      DIRECTORY_WEB_SERVICE: 'directory.uchicago.edu'
      DIRECTORY_PASSWORD: ${{ secrets.DIRECTORY_PASSWORD }}
      MARKLOGIC_LDR_USER: ${{ secrets.MARKLOGIC_LDR_USER }}
      MARKLOGIC_LDR_PASSWORD: ${{ secrets.MARKLOGIC_LDR_PASSWORD }}
      MARKLOGIC_LDR_URL: 'http://marklogic.lib.uchicago.edu:8008/v1/graphs'
      SPARQL_ROOT: 'https://repository.lib.uchicago.edu/digital_collections'
      GITHUB: ${{ secrets.GITHUB }}

    steps:

    - name: Start Elasticsearch
      run: |
        sudo swapoff -a
        sudo sysctl -w vm.swappiness=1
        sudo sysctl -w fs.file-max=262144
        sudo sysctl -w vm.max_map_count=262144
        docker rm -f es 2>/dev/null || true
        docker network create elastic 2>/dev/null || true
        docker run -d --name es --network elastic \
          -p 9200:9200 \
          -e discovery.type=single-node \
          -e xpack.security.enabled=false \
          -e ES_JAVA_OPTS="-Xms512m -Xmx512m" \
          docker.elastic.co/elasticsearch/elasticsearch:7.17.13
        until curl -s http://localhost:9200 | grep -q cluster_name; do sleep 5; done

    - uses: actions/checkout@v3

    - name: Start Redis
      run: |
        docker rm -f redis 2>/dev/null || true
        docker run -d --name redis -p 6379:6379 redis:6
        until docker exec redis redis-cli ping | grep -q PONG; do sleep 1; done

    - name: Set up Python '3.11'
      uses: actions/setup-python@v3
      with:
        python-version: '3.11'
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install -r requirements-dev.txt
    - run: |
        mkdir -p media/documents
    - name: Run tests
      run: |
        ./manage.py test --parallel
