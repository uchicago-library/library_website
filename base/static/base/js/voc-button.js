/**
 * This script adds a floating feedback button to the page with a certain probability.
 * If the button is clicked, it will not appear as often in the future.
 * The script adds the user's URL and the button context to the form's URL, which populates the feedback form.
 * Additionally, a feedback link is also added to the footer of the page.
 * This script was generated by an LLM(Claude 3.5 Sonnet) and reviewed by VMG.
 * 
 * Expected elements on the page:
 * - A footer with a list identified by 'aria-labelledby="contact_label"'
 * - The feedback button will be appended to the body if it exists
 */

document.addEventListener('DOMContentLoaded', function() {
    const currentPageUrl = encodeURIComponent(window.location.href);
    let feedbackLinkUrl = 'https://chicagobooth.az1.qualtrics.com/jfe/form/SV_0Ul7ULLhiDnN90W?context_url=' + currentPageUrl;

    // Check if the "Don't show this" button has been clicked before
    const dontShowClicked = localStorage.getItem('dontShowFeedbackFlag') === 'true';

    if (!dontShowClicked) {
        // Create the feedback flag element
        const feedbackFlag = document.createElement('div');
        feedbackFlag.className = 'feedback-flag';
        feedbackFlag.innerHTML = `
            <div class="feedback-flag-content">
                <i class="fa fa-comment" aria-hidden="true"></i> feedback
            </div>
            <div class="feedback-flag-expanded">
                <p>Take a 3 minute survey to help us improve our website!</p>
                <button class="take-survey">Take the survey</button>
                <button class="dont-show">Don't show this</button>
            </div>
        `;

        // Define the CSS styles for the feedback flag
        const css = `
            .feedback-flag {
                position: fixed;
                z-index: 9999999999999;
                background-color: #800000;
                color: white;
                border: none;
                cursor: pointer;
                text-decoration: none;
                display: flex;
                align-items: center;
                justify-content: center;
                font-family: Arial, sans-serif;
                right: 0;
                bottom: 15vh;
                padding: 15px 5px;
                border-radius: 0 4px 4px 0;
                transition: all 0.3s ease;
            }
            .feedback-flag:hover, .feedback-flag.expanded {
                background-color: #570000;
                color: white;
                text-decoration: none;
            }
            .feedback-flag-content {
                writing-mode: vertical-lr;
                transform: rotate(180deg);
                display: flex;
                align-items: center;
                justify-content: center;
            }
            .feedback-flag-content i {
                transform: rotate(180deg);
                margin: 0 0 8px 0;
            }
            .feedback-flag-expanded {
                display: none;
                flex-direction: column;
                align-items: center;
                justify-content: center;
                padding: 10px;
                background-color: #570000;
                border-radius: 4px;
            }
            .feedback-flag.expanded .feedback-flag-expanded {
                display: flex;
            }
            .take-survey, .dont-show {
                margin: 5px;
                padding: 10px;
                background-color: white;
                color: #800000;
                border: none;
                cursor: pointer;
                font-family: Arial, sans-serif;
            }
            .take-survey:hover, .dont-show:hover {
                background-color: #ccc;
            }
            @media (min-width: 768px) {
                .feedback-flag {
                    right: 200px;
                    bottom: 0;
                    padding: 10px 15px;
                    border-radius: 4px 4px 0 0;
                    flex-direction: row;
                }
                .feedback-flag-content {
                    writing-mode: horizontal-tb;
                    transform: none;
                }
                .feedback-flag-content i {
                    transform: none;
                    margin: 0 8px 0 0;
                }
                .feedback-flag:hover .feedback-flag-expanded {
                    display: flex;
                }
            }
        `;

        const styleElement = document.createElement('style');
        styleElement.textContent = css;
        document.head.appendChild(styleElement);

        // Append the feedback flag to the body of the document
        document.body.appendChild(feedbackFlag);

        // Add event listeners for expanding the feedback flag
        feedbackFlag.addEventListener('click', function() {
            if (window.innerWidth <= 768) {
                feedbackFlag.classList.toggle('expanded');
            }
        });

        // Add event listener for the "Take the survey" button
        feedbackFlag.querySelector('.take-survey').addEventListener('click', function() {
            window.location.href = feedbackLinkUrl + '&button="flag"';
        });

        // Add event listener for the "Don't show this" button
        feedbackFlag.querySelector('.dont-show').addEventListener('click', function() {
            localStorage.setItem('dontShowFeedbackFlag', 'true');
            feedbackFlag.style.display = 'none';
        });
    }

    // Add feedback link to the footer
    const footerList = document.querySelector('ul[aria-labelledby="contact_label"]');
    if (footerList) {
        // Create a list item and link for the feedback
        const feedbackListItem = document.createElement('li');
        const feedbackLink = document.createElement('a');
        feedbackLink.href = feedbackLinkUrl + '&button="footer"';
        feedbackLink.textContent = 'Feedback';
        feedbackLink.setAttribute('data-ga-category', 'footer-links');
        feedbackLink.setAttribute('data-ga-action', 'click');
        feedbackLink.setAttribute('data-ga-label', 'Contact > Feedback');
        feedbackListItem.appendChild(feedbackLink);
        // Append the feedback link to the footer list
        footerList.appendChild(feedbackListItem);
    }
});
