/**
 * This script adds a floating feedback button to the page with a certain probability.
 * If the button is clicked, it will not appear as often in the future.
 * The script adds the user's URL and the button context to the form's URL, which populates the feedback form.
 * Additionally, a feedback link is also added to the footer of the page.
 * This script was generated by an LLM(Claude 3.5 Sonnet) and reviewed by VMG.
 * 
 * Expected elements on the page:
 * - A footer with a list identified by 'aria-labelledby="contact_label"'
 * - The feedback button will be appended to the body if it exists
 */

document.addEventListener('DOMContentLoaded', function() {
    const currentPageUrl = encodeURIComponent(window.location.href);
    let feedbackLinkUrl = 'https://chicagobooth.az1.qualtrics.com/jfe/form/SV_0Ul7ULLhiDnN90W?context_url=' + currentPageUrl;

    // Check if the "Don't show this" button has been clicked before
    const dontShowClicked = localStorage.getItem('dontShowFeedbackFlag') === 'true';

    if (!dontShowClicked) {
        // Create the feedback flag element
        const feedbackFlagWrapper = document.createElement('div');
        feedbackFlagWrapper.className = 'feedback-flag-wrapper';
        feedbackFlagWrapper.innerHTML = `
            <div class="feedback-flag">
                <i class="fa fa-comment" aria-hidden="true"></i> feedback
            </div>
            <div class="feedback-flag-content"> <!-- Renamed here -->
                <p>Take a 3 minute survey to help us improve our website!</p>
                <div class="button-row">
                    <button class="btn dont-show">Don't show this</button>
                    <a id="take-survey-button" href="`+feedbackLinkUrl + `&button=flag" target="_blank" class="tbn take-survey">Take Survey</a>
                </div>
            </div>
        `;

        // Define the CSS styles for the feedback flag
        const css = `
            .feedback-flag-wrapper {
                position: fixed;
                z-index: 9999999999999;
                right: 0;
                bottom: 15vh;
                transition: all 0.3s ease;
                display: flex;
                flex-direction: row;
            }
            .feedback-flag-wrapper .feedback-flag {
                background-color: #800000;
                color: white;
                display: flex;
                align-items: center;
                justify-content: center;
                font-family: Arial, sans-serif;
                cursor: pointer;
                text-decoration: none;
                writing-mode: vertical-lr;
                transform: rotate(180deg);
                border-radius: 0 4px 4px 0;
                padding: 15px 5px;
            }
            .feedback-flag-wrapper .feedback-flag i {
                transform: rotate(180deg);
                margin: 0 0 8px 0;
            }
            .feedback-flag-wrapper .feedback-flag-content { 
                display: none;
                flex-direction: column;
                align-items: center;
                justify-content: center;
                padding: 10px;
                background-color: #800000;
                color: white;
            }
            .feedback-flag-wrapper.expanded .feedback-flag-content { 
                display: flex;
            }
            .feedback-flag-wrapper .button-row {
                display: flex;
                flex-direction: row;
                gap: 10px;flex-wrap: wrap;
                justify-content: center;
                align-content: center;
            }
            .feedback-flag-wrapper .take-survey, 
            .feedback-flag-wrapper .dont-show {
                border: none;
                cursor: pointer;
                font-family: Arial, sans-serif;
                font-weight: bold;
                border-radius: 4px;

                display: inline-block;
                padding: 10px 20px;
                background-color: #007bff;
                color: white;
                text-decoration: none;
                text-align: center;
            }
            .feedback-flag-wrapper .take-survey {
                background-color: white;
                color: #800000;
            }
            .feedback-flag-wrapper .take-survey:hover {
                background-color: #fdf0f0;
                color: #800000;
            }
            .feedback-flag-wrapper .dont-show {
                background-color: #800000;
                color: white;
                border: 1px solid white;
            }
            .feedback-flag-wrapper .dont-show:hover {
                background-color: #700707;
                color: white;
            }
            .feedback-flag-wrapper.expanded .feedback-flag-content,
            .feedback-flag-wrapper:hover .feedback-flag-content { 
                display: flex;
            }
            @media (min-width: 768px) {
                .feedback-flag-wrapper {
                    right: 280px;
                    right: 20vw;
                    bottom: 0;
                    flex-direction: column;
                }
                .feedback-flag-wrapper .feedback-flag {
                    writing-mode: horizontal-tb;
                    transform: none;
                    border-radius: 4px 4px 0 0;
                    padding: 5px 15px;
                }
                .feedback-flag-wrapper .feedback-flag i {
                    transform: none;
                    margin: 0 8px 0 0;
                }
            }
        `;

        const styleElement = document.createElement('style');
        styleElement.textContent = css;
        document.head.appendChild(styleElement);

        // Append the feedback flag to the body of the document
        document.body.appendChild(feedbackFlagWrapper);

        // Add event listener for the click toggle
        feedbackFlagWrapper.addEventListener('click', function() {
            feedbackFlagWrapper.classList.toggle('expanded');
        });

        // Add event listener for the "Don't show this" button
        feedbackFlagWrapper.querySelector('.dont-show').addEventListener('click', function() {
            localStorage.setItem('dontShowFeedbackFlag', 'true');
            feedbackFlagWrapper.style.display = 'none';
        });
    }

    // Add feedback link to the footer
    const footerList = document.querySelector('ul[aria-labelledby="contact_label"]');
    if (footerList) {
        // Create a list item and link for the feedback
        const feedbackListItem = document.createElement('li');
        const feedbackLink = document.createElement('a');
        feedbackLink.href = feedbackLinkUrl + '&button=footer';
        feedbackLink.textContent = 'Feedback';
        feedbackLink.setAttribute('data-ga-category', 'footer-links');
        feedbackLink.setAttribute('data-ga-action', 'click');
        feedbackLink.setAttribute('data-ga-label', 'Contact > Feedback');
        feedbackListItem.appendChild(feedbackLink);
        // Append the feedback link to the footer list
        footerList.appendChild(feedbackListItem);
    }
});
