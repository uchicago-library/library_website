{% extends "base/public_base.html" %}
{% load wagtailcore_tags %}
{% load django_htmx %}

{% block extra_scripts %}
    <style>
        .htmx-indicator {
            opacity: 0;
            transition: opacity 200ms ease-in;
        }
        .htmx-request .htmx-indicator {
            opacity: 1;
        }
        .fa-spin {
            margin-right: 8px;
        }
        .answer-heading {
            margin-bottom: 0;
        }
    </style>
    {% htmx_script %}
{% endblock %}

{% block content %}
    <div class="container py-4">
        <div class="row">
            <div class="col-12">
                <div class="card mb-4">
                    <div class="card-body">
                        <!-- Form with htmx attributes for AJAX submission -->
                        <form id="chatbot-form" hx-get="{{ page.url }}" hx-target="#results-container" hx-indicator="#loading-indicator"
                            hx-trigger="submit" class="mb-0">
                            <div class="form-group">
                                <label for="chatbot-query" class="form-label">Ask a question:</label>
                                <textarea class="form-control" id="chatbot-query" name="q" rows="3"
                                    placeholder="Type your question here...">{{ query|default:'' }}</textarea>
                            </div>

                            <!-- Options rendered from server-provided `allowed_options` for validation and i18n -->
                            <fieldset class="form-group mb-3" id="chatbot-options">
                                <legend class="col-form-label">Add context from:</legend>
                                {% for slug, label, default in allowed_options %}
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="chatbot-opt-{{ forloop.counter0 }}" name="options" value="{{ slug }}"
                                            {% if form_submitted %}
                                                {% if selected_option_slugs and slug in selected_option_slugs %}checked{% endif %}
                                            {% else %}
                                                {% if default %}checked{% endif %}
                                            {% endif %}>
                                        <label class="form-check-label" for="chatbot-opt-{{ forloop.counter0 }}">{{ label }}</label>
                                    </div>
                                {% empty %}
                                    <p class="text-muted">No options available.</p>
                                {% endfor %}
                            </fieldset>

                            <button type="submit" class="btn btn-primary">Search</button>
                        </form>

                        <!-- Server-driven options rendered above; server will validate and assemble the query. No client-side prefixing needed. -->
                    </div>
                </div>
                <!-- Loading indicator that only shows during AJAX requests -->
                <div id="loading-indicator" class="htmx-indicator text-center my-4">
                    <div class="spinner-border" role="status">
                        <i class="fa fa-refresh fa-spin fa-fw" aria-hidden="true"></i>
                        <span>Querying LibBot...</span>
                    </div>
                </div>
                <!-- Results container that will be updated by htmx -->
                <div id="results-container">
                    {% include "chatbot/results_partial.html" %}
                </div>
            </div>
        </div>
    </div>
{% endblock content %}
